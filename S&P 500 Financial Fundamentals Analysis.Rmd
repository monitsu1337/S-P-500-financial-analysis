---
title: "S&P 500 Financial Fundamentals — Exploratory Analysis"
author: "Daniel Volkov"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    code_folding: hide
    df_print: paged
    theme: cosmo
    highlight: tango
    self_contained: true
---

> > **Goal.** Conduct a detailed exploratory analysis of the relationship between valuation metrics and fundamentals for S&P 500 companies, identifying patterns, correlations, and potential insights from the data.

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 7, fig.height = 4.5)
```

```{r libraries}
library(tidyverse)
library(boot)
library(scales)
```

## Load Data

> Update the path to your CSV as needed.

```{r load-data}
# Replace with your path or use here::here() if you have a project
# Example: df <- readr::read_csv(here::here("data", "financials.csv"))
df <- readr::read_csv("financials.csv")

# Quick peek
glimpse(df)
head(df)
```

## Clean & Prepare

```{r clean}
# Standardize variable names used in analysis

df <- df %>%
  rename(
    PE = `Price/Earnings`,
    EPS = `Earnings/Share`,
    DivYield = `Dividend Yield`,
    Low52 = `52 Week Low`,
    High52 = `52 Week High`,
    PriceToBook = `Price/Book`,
    PriceToSales = `Price/Sales`
  )

# Check Market Cap type
paste("Class of Market Cap column:", class(df$`Market Cap`))

# Convert Market Cap to numeric if needed (strip labels like B/M)
if (is.character(df$`Market Cap`) | is.factor(df$`Market Cap`)) {
  df <- df %>%
    mutate(`Market Cap` = as.character(`Market Cap`)) %>%
    mutate(MarketCapNum = readr::parse_number(`Market Cap`))
} else {
  df <- df %>%
    rename(MarketCapNum = `Market Cap`)
}

# Keep rows with essential vars present
required_vars <- c("PE", "PriceToBook", "MarketCapNum")

cat("Missing values per column (pre-clean):\n")
print(colSums(is.na(df)))

df_clean <- df %>%
  filter(!is.na(PE), !is.na(PriceToBook), !is.na(MarketCapNum))

cat("Rows before cleaning:", nrow(df), "\n")
cat("Rows after cleaning:", nrow(df_clean), "\n")
cat("Missing values after cleaning:\n")
print(colSums(is.na(df_clean)))
```

## Exploratory Data Analysis (EDA)

### Summary Statistics

```{r summary-stats}
summary(select(df_clean, any_of(c("Price", "PE", "EPS", "DivYield", "PriceToBook", "MarketCapNum"))))
```

### Distribution of P/E

```{r pe-hist}
 ggplot(df_clean, aes(x = PE)) +
   geom_histogram(binwidth = 5, fill = "#619CFF", color = "white", alpha = 0.85) +
   labs(title = "Distribution of P/E Ratios (S&P 500)", x = "Price/Earnings Ratio (P/E)", y = "Companies") +
   theme_minimal(base_size = 13) +
   theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
```

### Mean P/E by Sector

```{r pe-by-sector}
 df_clean %>%
   group_by(Sector) %>%
   summarise(mean_PE = mean(PE, na.rm = TRUE), .groups = "drop") %>%
   ggplot(aes(x = reorder(Sector, mean_PE), y = mean_PE)) +
   geom_col(fill = "#56B4E9", width = 0.7) +
   coord_flip() +
   labs(title = "Mean P/E Ratio by Sector (S&P 500)", x = "Sector", y = "Mean P/E Ratio") +
   theme_minimal(base_size = 13) +
   theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5), axis.text.y = element_text(size = 11))
```

### EPS vs P/E

```{r eps-vs-pe}
 ggplot(df_clean, aes(x = EPS, y = PE)) +
   geom_point(alpha = 0.65, color = "#204080", size = 2) +
   labs(title = "Relationship Between EPS and P/E Ratio", x = "Earnings Per Share (EPS)", y = "Price/Earnings Ratio (P/E)") +
   theme_minimal(base_size = 13) +
   theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
```

### Market Cap vs P/E (Log X)

```{r mcap-vs-pe}
 ggplot(df_clean, aes(x = MarketCapNum, y = PE)) +
   geom_point(alpha = 0.65, color = "#800080", size = 2) +
   scale_x_log10(labels = comma) +
   labs(title = "Market Capitalization vs. P/E Ratio (Log Scale)", x = "Market Cap (log scale, USD)", y = "Price/Earnings Ratio (P/E)") +
   theme_minimal(base_size = 13) +
   theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
```

## Correlations

```{r corrs}
df_numeric <- df_clean %>% select(any_of(c("Price", "PE", "EPS", "DivYield", "PriceToBook", "MarketCapNum")))
cor_matrix <- cor(df_numeric, use = "complete.obs")
round(cor_matrix, 2)
```

## Sampling & Bootstrapping

```{r bootstrap}
set.seed(123)
sample_30 <- df_clean %>% sample_n(30)
cat("Mean P/E in random sample of 30 companies:", round(mean(sample_30$PE), 2), "\n")

boot_mean_pe <- function(data, indices) {
  sample_data <- data[indices, ]
  mean(sample_data$PE, na.rm = TRUE)
}

boot_result <- boot(data = df_clean, statistic = boot_mean_pe, R = 1000)
cat("Bootstrap estimate of mean P/E:", round(boot_result$t0, 2), "\n")

boot_ci <- boot.ci(boot_result, type = "perc")
boot_ci

# Visualize bootstrap means
boot_means <- boot_result$t %>% as.numeric()

ggplot(data.frame(mean_PE = boot_means), aes(x = mean_PE)) +
  geom_histogram(bins = 30, fill = "#009E73", color = "white", alpha = 0.85) +
  labs(title = "Bootstrap Distribution of Mean P/E Ratio", x = "Mean P/E Ratio", y = "Frequency") +
  theme_minimal(base_size = 13) +
  theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
```

## Hypothesis Testing

```{r ttest-anova}
# Label tech vs non-tech

unique(df_clean$Sector)

df_clean <- df_clean %>% mutate(IsTech = ifelse(Sector == "Information Technology", "Tech", "Non-Tech"))

# Group means
 df_clean %>%
   group_by(IsTech) %>%
   summarise(avg_PE = mean(PE, na.rm = TRUE), count = n(), .groups = "drop")

# Two-sample t-test
 t.test(PE ~ IsTech, data = df_clean)

# ANOVA across all sectors
 anova_result <- aov(PE ~ Sector, data = df_clean)
 summary(anova_result)
```

## Regression Modeling

```{r regressions}
model1 <- lm(PE ~ EPS, data = df_clean)
summary(model1)

model2 <- lm(PE ~ EPS + DivYield + PriceToBook + MarketCapNum, data = df_clean)
summary(model2)
```

### Visual: Linear Fit (P/E ~ EPS)

```{r reg-plot}
 ggplot(df_clean, aes(x = EPS, y = PE)) +
   geom_point(alpha = 0.65, color = "#205090", size = 2) +
   geom_smooth(method = "lm", se = TRUE, color = "#E69F00", linetype = "solid", linewidth = 1.2) +
   labs(title = "Linear Regression: P/E Ratio vs. EPS", x = "Earnings Per Share (EPS)", y = "Price/Earnings Ratio (P/E)") +
   theme_minimal(base_size = 13) +
   theme(plot.title = element_text(face = "bold", size = 16, hjust = 0.5))
```

### Diagnostics (Model 2)

```{r diag, fig.height=6, fig.width=6}
par(mfrow = c(2, 2))
plot(model2)
par(mfrow = c(1, 1))
```

## Key Findings 

- **Dividend Yield** tends to be **negatively** related to **P/E**.
- **Market Cap** shows a **positive** association with **P/E** (statistically significant in many datasets).
- **EPS** and **Price-to-Book** sometimes have weak/unstable effects on **P/E** once you control for the other variables.
- Differences in **P/E** between **Tech** and **Non‑Tech** (or across sectors) are **often not significant** at the 95% level (depends on your exact data snapshot).
- The multiple‑regression model explains a **modest** portion of P/E variation—consistent with the idea that valuation is influenced by many factors beyond fundamentals.